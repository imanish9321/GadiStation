<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GaadiStation ‚Äî Find Your Fuel</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOKENS ‚Äî Light theme, deep green + deep blue
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --ev:        #166534;
  --ev-dim:    #14532d;
  --ev-mid:    #16a34a;
  --ev-light:  #dcfce7;
  --ev-glow:   rgba(22,101,52,.12);
  --ice:       #1e40af;
  --ice-dim:   #1e3a8a;
  --ice-mid:   #2563eb;
  --ice-light: #dbeafe;
  --ice-glow:  rgba(30,64,175,.12);
  --bg:        #f4f9f6;
  --bg2:       #eaf3ee;
  --panel:     #ffffff;
  --card:      #ffffff;
  --card2:     #f8fffe;
  --border:    rgba(0,0,0,.09);
  --border2:   rgba(0,0,0,.14);
  --t1:  #0d1f16;
  --t2:  #3a6b51;
  --t3:  #86a896;
  --s1: 0 1px 3px rgba(0,0,0,.07), 0 2px 8px rgba(0,0,0,.05);
  --s2: 0 4px 12px rgba(0,0,0,.09), 0 8px 28px rgba(0,0,0,.06);
  --s3: 0 12px 36px rgba(0,0,0,.12), 0 4px 14px rgba(0,0,0,.07);
  --r1: 10px;
  --r2: 16px;
  --r3: 24px;
}

*,*::before,*::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; -webkit-font-smoothing:antialiased; }

body {
  font-family:'Outfit',sans-serif;
  background:var(--bg);
  color:var(--t1);
  min-height:100vh;
  overflow-x:hidden;
}

.bg-layer {
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(ellipse 60% 50% at 5% 0%,   rgba(22,101,52,.07)  0%, transparent 55%),
    radial-gradient(ellipse 50% 55% at 95% 90%,  rgba(30,64,175,.06)  0%, transparent 55%),
    radial-gradient(ellipse 35% 40% at 50% 50%,  rgba(22,163,74,.04)  0%, transparent 65%);
}
.bg-grid {
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background-image:
    linear-gradient(rgba(22,101,52,.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(22,101,52,.03) 1px, transparent 1px);
  background-size:48px 48px;
  mask-image:radial-gradient(ellipse 80% 80% at 50% 50%, black 30%, transparent 100%);
}
.bg-road {
  position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden;
}
.bg-road::before {
  content:''; position:absolute; bottom:-20%; left:50%;
  width:2px; height:80%;
  background:linear-gradient(to top, rgba(22,101,52,.1), transparent);
  transform:translateX(-50%);
  box-shadow:-60px 0 0 rgba(22,101,52,.03), 60px 0 0 rgba(22,101,52,.03);
}

#particles { position:fixed; inset:0; z-index:0; pointer-events:none; }
.particle {
  position:absolute; border-radius:50%;
  animation:rise linear infinite; opacity:0;
}
@keyframes rise {
  0%   { transform:translateY(100vh) scale(0); opacity:0; }
  8%   { opacity:.35; }
  92%  { opacity:.1; }
  100% { transform:translateY(-8vh) scale(1); opacity:0; }
}

.wrap { position:relative; z-index:1; display:flex; flex-direction:column; min-height:100vh; }

header {
  position:sticky; top:0; z-index:200;
  display:grid; grid-template-columns:1fr auto 1fr;
  align-items:center; padding:0 28px; height:64px;
  background:rgba(244,249,246,.92);
  backdrop-filter:blur(20px) saturate(160%);
  border-bottom:1px solid var(--border);
  box-shadow:0 1px 12px rgba(0,0,0,.07);
}

.logo { display:flex; align-items:center; gap:12px; }
.logo-mark {
  width:36px; height:36px; border-radius:10px; flex-shrink:0;
  background:linear-gradient(135deg,var(--ev-mid),var(--ev));
  display:flex; align-items:center; justify-content:center; font-size:.95rem;
  box-shadow:0 0 0 1px rgba(22,101,52,.25), 0 3px 10px rgba(22,101,52,.2);
}
.logo-name { font-size:1.25rem; font-weight:800; letter-spacing:-.3px; line-height:1; }
.logo-name em  { font-style:normal; color:var(--ev); }
.logo-name b   { font-style:normal; color:var(--ice); }
.logo-name .sub { display:block; font-size:.5rem; font-weight:400; letter-spacing:3px; color:var(--t3); margin-top:3px; }

.header-steps { display:flex; align-items:center; gap:0; justify-content:center; }
@media(max-width:680px){ .header-steps { display:none; } }

.hstep { display:flex; align-items:center; gap:6px; padding:4px 10px; border-radius:30px; transition:all .3s; }
.hstep-num {
  width:24px; height:24px; border-radius:50%;
  background:var(--bg2); border:1.5px solid var(--border2);
  display:flex; align-items:center; justify-content:center;
  font-size:.68rem; font-weight:700; color:var(--t3); transition:all .35s;
}
.hstep-lbl { font-size:.64rem; font-weight:600; letter-spacing:.5px; color:var(--t3); }
.hstep.active .hstep-num { background:var(--ev); border-color:var(--ev); color:#fff; box-shadow:0 0 10px var(--ev-glow); }
.hstep.active .hstep-lbl { color:var(--ev); }
.hstep.done   .hstep-num { background:var(--ev-mid); border-color:var(--ev-mid); color:#fff; }
.hstep.done   .hstep-lbl { color:var(--ev-mid); }
.hstep-line { width:28px; height:2px; background:var(--border2); border-radius:2px; transition:background .4s; }
.hstep.active + .hstep-line, .hstep.done + .hstep-line { background:var(--ev-mid); }

body.mode-ice .hstep.active .hstep-num { background:var(--ice); border-color:var(--ice); color:#fff; box-shadow:0 0 10px var(--ice-glow); }
body.mode-ice .hstep.active .hstep-lbl { color:var(--ice); }
body.mode-ice .hstep.done   .hstep-num { background:var(--ice-mid); border-color:var(--ice-mid); color:#fff; }
body.mode-ice .hstep.done   .hstep-lbl { color:var(--ice-mid); }
body.mode-ice .hstep.done + .hstep-line,
body.mode-ice .hstep.active + .hstep-line { background:var(--ice-mid); }

.header-right { display:flex; justify-content:flex-end; align-items:center; gap:10px; }
.india-badge {
  display:flex; align-items:center; gap:6px; padding:5px 14px; border-radius:30px;
  background:var(--bg2); border:1px solid var(--border2);
  font-size:.7rem; font-weight:700; color:var(--t2); letter-spacing:.5px;
}

.hero { padding:72px 24px 48px; text-align:center; position:relative; overflow:hidden; }

.hero-pill {
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 16px 6px 8px; border-radius:40px;
  background:var(--ev-light); border:1px solid rgba(22,101,52,.2);
  margin-bottom:24px; animation:fadeUp .7s ease both;
}
.hero-pill-dot {
  width:24px; height:24px; border-radius:50%;
  background:linear-gradient(135deg,var(--ev-mid),var(--ev));
  display:flex; align-items:center; justify-content:center;
  font-size:.65rem; box-shadow:0 2px 8px var(--ev-glow);
}
.hero-pill span { font-size:.65rem; font-weight:700; letter-spacing:2.5px; color:var(--ev); }

.hero-h1 {
  font-size:clamp(2.4rem,6.5vw,5.6rem);
  font-weight:900; line-height:1.0; letter-spacing:-1.5px;
  animation:fadeUp .8s .08s ease both;
}
.hero-h1 .ev-w  { color:var(--ev);  }
.hero-h1 .ice-w { color:var(--ice); }
.hero-h1 .soft  { color:var(--t2); font-weight:300; }

.hero-sub { margin-top:16px; font-size:1.05rem; color:var(--t2); font-weight:400; animation:fadeUp .9s .16s ease both; }
.hero-sub .deva { font-family:'Noto Sans Devanagari',sans-serif; color:var(--t1); font-weight:600; }

.hero-badges { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:28px; animation:fadeUp 1s .24s ease both; }
.hbadge {
  display:flex; align-items:center; gap:6px; padding:7px 14px; border-radius:30px;
  background:var(--panel); border:1px solid var(--border2);
  font-size:.72rem; font-weight:600; color:var(--t2); box-shadow:var(--s1);
}
.hbadge-dot { width:6px; height:6px; border-radius:50%; }

@keyframes fadeUp {
  from { opacity:0; transform:translateY(24px); }
  to   { opacity:1; transform:translateY(0); }
}

.mobile-steps { display:none; justify-content:center; margin-top:28px; gap:8px; align-items:center; animation:fadeUp 1s .32s ease both; }
@media(max-width:680px){ .mobile-steps { display:flex; } }
.mstep {
  width:32px; height:32px; border-radius:50%;
  background:var(--bg2); border:1.5px solid var(--border2);
  display:flex; align-items:center; justify-content:center;
  font-size:.72rem; font-weight:700; color:var(--t3); transition:all .35s;
}
.mstep.active { background:var(--ev); border-color:var(--ev); color:#fff; box-shadow:0 0 12px var(--ev-glow); }
.mstep.done   { background:var(--ev-mid); border-color:var(--ev-mid); color:#fff; }
body.mode-ice .mstep.active { background:var(--ice); border-color:var(--ice); color:#fff; box-shadow:0 0 12px var(--ice-glow); }
body.mode-ice .mstep.done   { background:var(--ice-mid); border-color:var(--ice-mid); color:#fff; }
.mstep-line { width:20px; height:2px; background:var(--border2); border-radius:2px; transition:background .4s; }
.mstep.active + .mstep-line, .mstep.done + .mstep-line { background:var(--ev-mid); }
body.mode-ice .mstep.active + .mstep-line,
body.mode-ice .mstep.done   + .mstep-line { background:var(--ice-mid); }
.mstep-lbl { display:none; }

.content { flex:1; max-width:960px; width:100%; margin:0 auto; padding:0 20px 100px; }

#step-vehicle { animation:stepIn .5s ease both; }

.step-eyebrow {
  text-align:center; font-size:.65rem; font-weight:700;
  letter-spacing:3px; color:var(--t3); margin-bottom:28px;
  display:flex; align-items:center; justify-content:center; gap:14px;
}
.step-eyebrow::before, .step-eyebrow::after {
  content:''; flex:1; max-width:72px; height:1px;
  background:linear-gradient(90deg,transparent,var(--border2));
}
.step-eyebrow::after { background:linear-gradient(90deg,var(--border2),transparent); }

.vgrid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
@media(max-width:560px){ .vgrid { grid-template-columns:1fr; } }

.vcard {
  position:relative; overflow:hidden;
  background:var(--card); border:1.5px solid var(--border2);
  border-radius:var(--r3); padding:44px 28px 36px;
  cursor:pointer; text-align:center;
  transition:transform .32s cubic-bezier(.34,1.4,.64,1), box-shadow .32s, border-color .25s;
  box-shadow:var(--s2);
}
.vcard::before {
  content:''; position:absolute; top:0; left:0; right:0; height:3px;
  opacity:0; transition:opacity .35s;
}
.vcard.ev::before  { background:linear-gradient(90deg,transparent,var(--ev),transparent); }
.vcard.ice::before { background:linear-gradient(90deg,transparent,var(--ice),transparent); }
.vcard::after {
  content:''; position:absolute; inset:0; opacity:0;
  transition:opacity .4s; pointer-events:none;
}
.vcard.ev::after  { background:radial-gradient(ellipse 70% 50% at 50% -5%,rgba(22,101,52,.06),transparent 55%); }
.vcard.ice::after { background:radial-gradient(ellipse 70% 50% at 50% -5%,rgba(30,64,175,.06),transparent 55%); }
.vcard:hover::before, .vcard.selected::before { opacity:1; }
.vcard:hover::after,  .vcard.selected::after  { opacity:1; }
.vcard.ev:hover,  .vcard.ev.selected  {
  border-color:var(--ev-mid); transform:translateY(-8px) scale(1.01);
  box-shadow:0 0 0 1px var(--ev-mid), 0 20px 50px rgba(22,101,52,.12), var(--s2);
}
.vcard.ice:hover, .vcard.ice.selected {
  border-color:var(--ice-mid); transform:translateY(-8px) scale(1.01);
  box-shadow:0 0 0 1px var(--ice-mid), 0 20px 50px rgba(30,64,175,.12), var(--s2);
}
.vcard-corner { position:absolute; top:0; right:0; width:60px; height:60px; overflow:hidden; }
.vcard-corner::after {
  content:''; position:absolute; top:-30px; right:-30px;
  width:60px; height:60px; border-radius:50%; opacity:.1;
}
.vcard.ev  .vcard-corner::after { background:var(--ev); }
.vcard.ice .vcard-corner::after { background:var(--ice); }
.vcheck {
  position:absolute; top:16px; left:16px;
  width:26px; height:26px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:.72rem; color:#fff; opacity:0;
  transform:scale(0) rotate(-90deg);
  transition:all .35s cubic-bezier(.34,1.4,.64,1);
}
.vcard.ev.selected  .vcheck { opacity:1; transform:scale(1) rotate(0deg); background:var(--ev); }
.vcard.ice.selected .vcheck { opacity:1; transform:scale(1) rotate(0deg); background:var(--ice); }
.vbadge {
  position:absolute; top:16px; right:16px;
  font-size:.55rem; font-weight:800; letter-spacing:1.5px; padding:4px 10px; border-radius:8px;
}
.vcard.ev  .vbadge { background:var(--ev-light); color:var(--ev);  border:1px solid rgba(22,101,52,.2); }
.vcard.ice .vbadge { background:var(--ice-light); color:var(--ice); border:1px solid rgba(30,64,175,.2); }
.vicon {
  font-size:3.6rem; display:block; margin-bottom:16px;
  filter:drop-shadow(0 4px 10px rgba(0,0,0,.15));
  animation:bob 3.2s ease-in-out infinite; position:relative; z-index:1;
}
.vcard.ice .vicon { animation-delay:1.6s; }
@keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
.vname { font-size:1.9rem; font-weight:800; letter-spacing:-.5px; margin-bottom:3px; position:relative; z-index:1; }
.vcard.ev  .vname { color:var(--ev); }
.vcard.ice .vname { color:var(--ice); }
.vhindi { font-family:'Noto Sans Devanagari',sans-serif; font-size:1.05rem; color:var(--t2); margin:3px 0 12px; position:relative; z-index:1; }
.vdesc  { font-size:.8rem; color:var(--t3); line-height:1.6; position:relative; z-index:1; }

#step-range { display:none; animation:stepIn .5s ease both; }

.range-top { text-align:center; margin-bottom:36px; }
.range-type-chip {
  display:inline-flex; align-items:center; gap:8px; padding:7px 18px; border-radius:40px;
  background:var(--panel); border:1px solid var(--border2);
  font-size:.85rem; font-weight:600; color:var(--t1); margin-bottom:14px; box-shadow:var(--s1);
}
.range-top h2  { font-size:clamp(1.6rem,4vw,2.4rem); font-weight:800; letter-spacing:-.5px; color:var(--t1); }
.range-top p   { color:var(--t2); font-size:.9rem; margin-top:8px; }

.rpills { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom:36px; }
.rpill {
  position:relative; overflow:hidden;
  padding:12px 26px; border-radius:50px;
  border:1.5px solid var(--border2); background:var(--card);
  font-family:'Outfit',sans-serif; font-size:1.05rem; font-weight:800;
  color:var(--t2); cursor:pointer;
  transition:all .25s cubic-bezier(.34,1.2,.64,1); box-shadow:var(--s1);
}
.rpill::after { content:' km'; font-size:.62rem; letter-spacing:1px; font-weight:600; }
.rpill:hover  { color:var(--t1); border-color:var(--border2); transform:translateY(-3px); box-shadow:var(--s2); }
.rpill.active { transform:translateY(-4px); }
body.mode-ev  .rpill.active { border-color:var(--ev);  background:var(--ev-light);  color:var(--ev);  box-shadow:0 0 0 1px var(--ev), 0 6px 20px rgba(22,101,52,.18); }
body.mode-ice .rpill.active { border-color:var(--ice); background:var(--ice-light); color:var(--ice); box-shadow:0 0 0 1px var(--ice), 0 6px 20px rgba(30,64,175,.18); }

.loc-card {
  max-width:600px; margin:0 auto 32px;
  background:var(--card); border:1px solid var(--border2);
  border-radius:var(--r3); padding:24px; box-shadow:var(--s2);
}
.loc-card-title {
  font-size:.6rem; font-weight:800; letter-spacing:2.5px; color:var(--t3);
  margin-bottom:16px; display:flex; align-items:center; gap:10px;
}
.loc-card-title::after { content:''; flex:1; height:1px; background:var(--border); }

.segtabs {
  display:flex; gap:4px; padding:4px;
  background:var(--bg2); border-radius:12px; margin-bottom:18px;
  border:1px solid var(--border);
}
.segtab {
  flex:1; padding:9px 12px; border-radius:9px; border:none;
  background:transparent; font-family:'Outfit',sans-serif;
  font-size:.82rem; font-weight:600; color:var(--t3); cursor:pointer; transition:all .22s;
}
.segtab:hover { color:var(--t2); }
.segtab.active { background:var(--panel); color:var(--t1); box-shadow:var(--s1); }

.city-row { display:flex; gap:10px; align-items:flex-start; }
.citybox  { flex:1; position:relative; }
.citybox input {
  width:100%; padding:13px 42px 13px 16px;
  background:var(--bg2); border:1.5px solid var(--border);
  border-radius:var(--r1); color:var(--t1);
  font-family:'Outfit',sans-serif; font-size:.9rem; font-weight:400;
  outline:none; transition:border-color .25s, box-shadow .25s;
}
.citybox input:focus           { border-color:var(--ev-mid);  box-shadow:0 0 0 3px rgba(22,101,52,.1); }
body.mode-ice .citybox input:focus { border-color:var(--ice-mid); box-shadow:0 0 0 3px rgba(30,64,175,.1); }
.citybox input::placeholder { color:var(--t3); }
.clr-btn {
  position:absolute; top:50%; right:12px; transform:translateY(-50%);
  color:var(--t3); cursor:pointer; font-size:.8rem; transition:color .2s;
  width:20px; height:20px; display:flex; align-items:center; justify-content:center;
  border-radius:50%; background:var(--bg2); border:1px solid var(--border);
}
.clr-btn:hover { color:var(--t1); background:var(--border2); }

.suggest-list {
  position:absolute; top:calc(100% + 8px); left:0; right:0;
  background:var(--panel); border:1px solid var(--border2);
  border-radius:var(--r2); overflow:hidden; z-index:300;
  box-shadow:var(--s3); max-height:240px; overflow-y:auto;
}
.sug-item {
  padding:11px 16px; cursor:pointer; font-size:.86rem;
  display:flex; align-items:center; gap:10px;
  border-bottom:1px solid var(--border); transition:background .15s;
}
.sug-item:last-child { border-bottom:none; }
.sug-item:hover { background:var(--bg2); }
.sug-ico  { font-size:.95rem; flex-shrink:0; }
.sug-main { color:var(--t1); font-weight:600; }
.sug-sub  { color:var(--t3); font-size:.72rem; margin-top:2px; }
.sug-load { padding:14px 16px; color:var(--t3); font-size:.84rem; }

.gps-btn {
  display:flex; flex-direction:column; align-items:center;
  gap:3px; padding:11px 14px; border-radius:var(--r1);
  border:1.5px solid var(--border2); background:var(--bg2);
  color:var(--t3); cursor:pointer; min-width:74px; flex-shrink:0;
  font-family:'Outfit',sans-serif; transition:all .25s;
}
.gps-btn:hover { border-color:var(--t2); color:var(--t1); transform:translateY(-2px); }
.gps-btn.active            { background:var(--ev-light); border-color:var(--ev); color:var(--ev); box-shadow:0 2px 12px var(--ev-glow); }
body.mode-ice .gps-btn.active { background:var(--ice-light); border-color:var(--ice); color:var(--ice); box-shadow:0 2px 12px var(--ice-glow); }
.gps-btn.loading { pointer-events:none; }
.gps-ico { font-size:1.3rem; line-height:1; }
.gps-lbl { font-size:.6rem; font-weight:700; letter-spacing:.5px; }
@keyframes rotSpin { to { transform:rotate(360deg); } }
.gps-btn.loading .gps-ico { display:inline-block; animation:rotSpin 1s linear infinite; }

.hint { font-size:.7rem; color:var(--t3); margin-top:9px; padding-left:2px; font-weight:500; }
.hint strong { color:var(--ev); }

/* GPS warning banner */
.https-warn {
  display:none; align-items:center; gap:8px; padding:10px 14px;
  background:#fffbeb; border:1px solid #fbbf24; border-radius:var(--r1);
  font-size:.78rem; color:#92400e; margin-bottom:12px; line-height:1.5;
}
.https-warn.show { display:flex; }

.pin-row { display:flex; gap:10px; }
.pinbox {
  flex:1; display:flex; align-items:center;
  background:var(--bg2); border:1.5px solid var(--border);
  border-radius:var(--r1); overflow:hidden; position:relative; transition:all .25s;
}
.pinbox:focus-within            { border-color:var(--ev-mid);  box-shadow:0 0 0 3px rgba(22,101,52,.1); }
body.mode-ice .pinbox:focus-within { border-color:var(--ice-mid); box-shadow:0 0 0 3px rgba(30,64,175,.1); }
.pin-flag { padding:0 10px 0 14px; font-size:1.15rem; flex-shrink:0; }
.pinbox input {
  flex:1; padding:13px 36px 13px 0; background:transparent; border:none;
  color:var(--t1); font-family:'Outfit',sans-serif;
  font-size:1.25rem; font-weight:800; letter-spacing:5px; outline:none;
}
.pinbox input::placeholder { font-size:.8rem; color:var(--t3); letter-spacing:.5px; font-weight:400; }
#pin-clear { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--t3); }
.pin-go {
  padding:13px 18px; border-radius:var(--r1);
  border:1.5px solid var(--border2); background:var(--bg2);
  color:var(--t3); font-family:'Outfit',sans-serif;
  font-size:.9rem; font-weight:800; letter-spacing:1px;
  cursor:pointer; flex-shrink:0; transition:all .25s;
}
.pin-go:disabled { opacity:.35; cursor:not-allowed; }
.pin-go:not(:disabled):hover { transform:translateY(-2px); box-shadow:var(--s1); }
body.mode-ev  .pin-go:not(:disabled) { border-color:var(--ev);  color:var(--ev);  background:var(--ev-light); }
body.mode-ice .pin-go:not(:disabled) { border-color:var(--ice); color:var(--ice); background:var(--ice-light); }

.pin-status { margin-top:10px; padding:9px 14px; border-radius:var(--r1); font-size:.82rem; animation:stepIn .3s ease both; }
.pin-status.loading { background:var(--bg2); color:var(--t2); border:1px solid var(--border); }
.pin-status.error   { background:#fef2f2; color:#dc2626; border:1px solid #fca5a5; }
.pin-status.success { background:var(--ev-light); color:var(--ev); border:1px solid rgba(22,101,52,.25); }
body.mode-ice .pin-status.success { background:var(--ice-light); color:var(--ice); border-color:rgba(30,64,175,.25); }

.loc-confirmed {
  display:flex; align-items:center; gap:10px; margin-top:12px; padding:10px 16px;
  background:var(--ev-light); border:1px solid rgba(22,101,52,.2);
  border-radius:var(--r1); font-size:.83rem; color:var(--t1); animation:stepIn .4s ease both;
}
body.mode-ice .loc-confirmed { background:var(--ice-light); border-color:rgba(30,64,175,.2); }
.loc-pulse {
  width:8px; height:8px; border-radius:50%; flex-shrink:0;
  background:var(--ev); animation:pulse 2s infinite;
}
body.mode-ice .loc-pulse { background:var(--ice); }
@keyframes pulse {
  0%,100% { box-shadow:0 0 0 0 rgba(22,101,52,.4); }
  50%      { box-shadow:0 0 0 8px transparent; }
}

.cta-btn {
  display:flex; align-items:center; justify-content:center; gap:10px;
  margin:0 auto; padding:17px 60px; border-radius:60px; border:none; cursor:pointer;
  font-family:'Outfit',sans-serif; font-size:1.1rem; font-weight:800;
  letter-spacing:.5px; position:relative; overflow:hidden;
  transition:transform .3s cubic-bezier(.34,1.3,.64,1), box-shadow .3s;
}
.cta-btn::before {
  content:''; position:absolute; inset:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);
  transform:translateX(-100%); transition:transform .55s;
}
.cta-btn:hover::before { transform:translateX(100%); }
.cta-btn:hover { transform:translateY(-4px); }
body.mode-ev  .cta-btn { background:linear-gradient(135deg,var(--ev-mid),var(--ev)); color:#fff; box-shadow:0 4px 20px rgba(22,101,52,.35), 0 1px 4px rgba(22,101,52,.2); }
body.mode-ice .cta-btn { background:linear-gradient(135deg,var(--ice-mid),var(--ice)); color:#fff; box-shadow:0 4px 20px rgba(30,64,175,.35), 0 1px 4px rgba(30,64,175,.2); }

.back-link {
  display:block; text-align:center; margin-top:18px;
  font-size:.78rem; color:var(--t3); text-decoration:none; transition:color .2s; font-weight:500;
}
.back-link:hover { color:var(--t2); }

#step-results { display:none; animation:stepIn .5s ease both; }

.results-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap:12px; flex-wrap:wrap; }
.results-nav h2 { font-size:clamp(1.3rem,4vw,1.8rem); font-weight:800; letter-spacing:-.4px; }
.restart-btn {
  padding:8px 18px; border-radius:30px; border:1px solid var(--border2); background:transparent;
  color:var(--t2); font-family:'Outfit',sans-serif; font-size:.8rem; font-weight:600; cursor:pointer; transition:all .2s;
}
.restart-btn:hover { border-color:var(--t1); color:var(--t1); }

.info-bar {
  display:flex; align-items:center; gap:10px;
  background:var(--panel); border:1px solid var(--border2);
  border-radius:var(--r2); padding:12px 18px; margin-bottom:16px; font-size:.84rem;
  box-shadow:var(--s1);
}
.info-bar strong { color:var(--t1); }
.info-bar span   { color:var(--t3); }

.rangebar {
  display:flex; align-items:center; gap:12px; flex-wrap:wrap;
  background:var(--panel); border:1px solid var(--border); box-shadow:var(--s1);
  border-radius:var(--r2); padding:12px 18px; margin-bottom:22px;
}
.rangebar-lbl { font-size:.65rem; font-weight:800; letter-spacing:1px; color:var(--t3); white-space:nowrap; }
.crpills { display:flex; gap:7px; flex-wrap:wrap; }
.crpill {
  padding:6px 16px; border-radius:30px; border:1.5px solid var(--border2); background:var(--bg2);
  font-family:'Outfit',sans-serif; font-size:.88rem; font-weight:700;
  color:var(--t3); cursor:pointer; transition:all .22s;
}
.crpill:hover { border-color:var(--t2); color:var(--t2); transform:translateY(-2px); }
.crpill.active { transform:translateY(-2px); }
body.mode-ev  .crpill.active { border-color:var(--ev);  background:var(--ev-light);  color:var(--ev);  box-shadow:0 0 0 1px var(--ev),  0 3px 10px rgba(22,101,52,.15); }
body.mode-ice .crpill.active { border-color:var(--ice); background:var(--ice-light); color:var(--ice); box-shadow:0 0 0 1px var(--ice), 0 3px 10px rgba(30,64,175,.15); }
.crpill.loading { opacity:.5; pointer-events:none; }

.rgrid { display:grid; grid-template-columns:repeat(auto-fill,minmax(268px,1fr)); gap:16px; }

.rcard {
  background:var(--card); border:1px solid var(--border2);
  border-radius:var(--r2); padding:18px; position:relative; overflow:hidden;
  box-shadow:var(--s1); animation:stepIn .5s ease both;
  transition:transform .25s cubic-bezier(.34,1.2,.64,1), box-shadow .25s;
}
.rcard::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
body.mode-ev  .rcard::before { background:linear-gradient(90deg,var(--ev-mid),var(--ev)); }
body.mode-ice .rcard::before { background:linear-gradient(90deg,var(--ice-mid),var(--ice)); }
.rcard::after {
  content:''; position:absolute; inset:0; opacity:0; pointer-events:none; transition:opacity .3s;
}
body.mode-ev  .rcard::after { background:linear-gradient(180deg,rgba(22,101,52,.03) 0%,transparent 40%); }
body.mode-ice .rcard::after { background:linear-gradient(180deg,rgba(30,64,175,.03) 0%,transparent 40%); }
.rcard:hover { transform:translateY(-5px); box-shadow:var(--s2); }
.rcard:hover::after { opacity:1; }

.rc-head { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
.rc-name { font-weight:700; font-size:.96rem; color:var(--t1); line-height:1.3; padding-right:8px; }
.rc-dist { font-size:.68rem; padding:4px 9px; border-radius:20px; flex-shrink:0; font-weight:800; white-space:nowrap; }
body.mode-ev  .rc-dist { background:var(--ev-light); color:var(--ev); }
body.mode-ice .rc-dist { background:var(--ice-light); color:var(--ice); }

.rc-addr { font-size:.77rem; color:var(--t3); margin-bottom:10px; line-height:1.45; }
.rc-tags { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px; }
.rc-tag {
  font-size:.65rem; padding:3px 8px; border-radius:6px;
  background:var(--bg2); color:var(--t2); border:1px solid var(--border);
}
.rc-rating { display:flex; align-items:center; gap:5px; font-size:.79rem; color:var(--t2); margin-bottom:10px; }
.stars { color:#d97706; font-size:.72rem; }

.rc-open   { font-size:.67rem; font-weight:700; color:#15803d; background:#dcfce7; padding:3px 8px; border-radius:6px; border:1px solid rgba(22,101,52,.2); }
.rc-closed { font-size:.67rem; font-weight:700; color:#dc2626; background:#fef2f2; padding:3px 8px; border-radius:6px; border:1px solid #fca5a5; }

.rc-btns { display:flex; gap:8px; margin-top:12px; }
.rc-navigate, .rc-directions {
  flex:1; padding:9px 6px; border-radius:var(--r1); text-align:center;
  font-family:'Outfit',sans-serif; font-size:.8rem; font-weight:700;
  cursor:pointer; transition:all .2s; border:1px solid; text-decoration:none; display:block;
}
body.mode-ev  .rc-navigate   { background:var(--ev-light);  color:var(--ev);  border-color:rgba(22,101,52,.25); }
body.mode-ice .rc-navigate   { background:var(--ice-light); color:var(--ice); border-color:rgba(30,64,175,.25); }
body.mode-ev  .rc-directions { background:var(--bg2); color:var(--ev-mid); border-color:rgba(22,101,52,.15); }
body.mode-ice .rc-directions { background:var(--bg2); color:var(--ice-mid); border-color:rgba(30,64,175,.15); }
.rc-navigate:hover, .rc-directions:hover { filter:brightness(.95); transform:scale(1.02); box-shadow:var(--s1); }

.inline-map { margin-top:10px; border-radius:var(--r1); overflow:hidden; border:1px solid var(--border2); animation:stepIn .3s ease both; }
.imap-bar {
  display:flex; align-items:center; gap:8px; padding:8px 12px;
  background:var(--bg2); border-bottom:1px solid var(--border);
}
.imap-title { flex:1; font-size:.75rem; font-weight:600; color:var(--t1); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.imap-ext   { font-size:.7rem; color:var(--t2); text-decoration:none; white-space:nowrap; transition:color .2s; }
.imap-ext:hover  { color:var(--t1); }
.imap-close { background:none; border:none; color:var(--t3); cursor:pointer; padding:2px 6px; border-radius:6px; transition:all .2s; font-size:.85rem; }
.imap-close:hover { color:var(--t1); background:var(--border); }

.empty-state { text-align:center; padding:72px 20px; color:var(--t3); }
.empty-state .ico { font-size:3.2rem; margin-bottom:14px; }
.empty-state h3 { color:var(--t1); font-size:1.2rem; margin-bottom:8px; }

@keyframes shimmer {
  0%   { background-position:-500px 0; }
  100% { background-position: 500px 0; }
}
.sk {
  border-radius:6px;
  background:linear-gradient(90deg,var(--bg2) 25%,rgba(0,0,0,.06) 50%,var(--bg2) 75%);
  background-size:500px 100%; animation:shimmer 1.4s infinite;
}

footer {
  text-align:center; padding:32px 20px;
  border-top:1px solid var(--border);
  background:rgba(244,249,246,.85); backdrop-filter:blur(8px);
  color:var(--t3); font-size:.74rem; letter-spacing:.3px; font-weight:500;
}
footer .fe { color:var(--ev); }
footer .fi { color:var(--ice); }

/* ‚îÄ‚îÄ TOAST ‚Äî wider + line-wrap support for long GPS messages ‚îÄ‚îÄ */
.toast {
  position:fixed; bottom:28px; left:50%;
  transform:translateX(-50%) translateY(90px);
  background:var(--t1); border:1px solid rgba(0,0,0,.15);
  border-radius:var(--r2); padding:13px 22px;
  font-size:.86rem; font-weight:600; z-index:999;
  transition:transform .4s cubic-bezier(.34,1.3,.64,1);
  text-align:center; max-width:420px; width:92%;
  box-shadow:var(--s3); color:var(--panel);
  line-height:1.55;
  word-break:break-word;
}
.toast.show { transform:translateX(-50%) translateY(0); }

@keyframes stepIn {
  from { opacity:0; transform:translateY(22px); }
  to   { opacity:1; transform:translateY(0); }
}

.hidden { display:none !important; }

@media(max-width:680px) {
  .hero { padding:48px 16px 32px; }
  .content { padding:0 14px 80px; }
  header { padding:0 16px; }
  .logo-name { font-size:1.1rem; }
  .cta-btn { padding:16px 40px; font-size:1rem; }
  .rangebar { flex-direction:column; align-items:flex-start; gap:10px; }
  .rgrid { grid-template-columns:1fr; }
  .loc-card { padding:18px 16px; }
  .hero-h1 { letter-spacing:-.8px; }
}
@media(min-width:900px) {
  .rangebar { flex-wrap:nowrap; }
}
  </style>
</head>
<body>

<div class="bg-layer"></div>
<div class="bg-grid"></div>
<div class="bg-road"></div>
<div id="particles"></div>

<div class="wrap">

<header>
  <div class="logo">
    <div class="logo-mark">‚õΩ</div>
    <div class="logo-name">
      <em>Gaadi</em><b>Station</b>
      <span class="sub">‡§ó‡§æ‡§°‡§º‡•Ä ‡§∏‡•ç‡§ü‡•á‡§∂‡§® &nbsp;¬∑&nbsp; FIND YOUR FUEL</span>
    </div>
  </div>

  <div class="header-steps">
    <div class="hstep active" id="si-1">
      <div class="hstep-num">1</div>
      <span class="hstep-lbl">GAADI TYPE</span>
    </div>
    <div class="hstep-line"></div>
    <div class="hstep" id="si-2">
      <div class="hstep-num">2</div>
      <span class="hstep-lbl">RANGE</span>
    </div>
    <div class="hstep-line"></div>
    <div class="hstep" id="si-3">
      <div class="hstep-num">3</div>
      <span class="hstep-lbl">RESULTS</span>
    </div>
  </div>

  <div class="header-right">
    <div class="india-badge">üáÆüá≥ INDIA</div>
  </div>
</header>

<section class="hero">
  <div class="hero-pill">
    <div class="hero-pill-dot">‚ö°</div>
    <span>SMART VEHICLE FUEL FINDER</span>
  </div>

  <h1 class="hero-h1">
    Find <span class="ev-w">Bijli</span> <span class="soft">or</span><br/>
    <span class="ice-w">Petrol</span> <span class="soft">Near You</span>
  </h1>

  <p class="hero-sub">
    For your <span class="deva">‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§ó‡§æ‡§°‡§º‡•Ä</span> or <span class="deva">‡§™‡•á‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§ó‡§æ‡§°‡§º‡•Ä</span> ‚Äî locate stations in seconds
  </p>

  <div class="hero-badges">
    <div class="hbadge"><div class="hbadge-dot" style="background:var(--ev)"></div>EV Charging Stations</div>
    <div class="hbadge"><div class="hbadge-dot" style="background:var(--ice)"></div>Petrol &amp; CNG Pumps</div>
    <div class="hbadge"><div class="hbadge-dot" style="background:#60a5fa"></div>All Across India</div>
  </div>

  <div class="mobile-steps">
    <div class="mstep active" id="msi-1">1</div>
    <div class="mstep-line"></div>
    <div class="mstep" id="msi-2">2</div>
    <div class="mstep-line"></div>
    <div class="mstep" id="msi-3">3</div>
  </div>
</section>

<div class="content">

  <div id="step-vehicle">
    <div class="step-eyebrow">SELECT YOUR GAADI TYPE</div>
    <div class="vgrid">

      <div class="vcard ev" onclick="selectVehicle('ev')">
        <div class="vcard-corner"></div>
        <div class="vcheck">‚úì</div>
        <span class="vbadge">ZERO EMISSION</span>
        <span class="vicon">‚ö°üöó</span>
        <div class="vname">Bijli Gaadi</div>
        <div class="vhindi">‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§ó‡§æ‡§°‡§º‡•Ä</div>
        <div class="vdesc">Electric Vehicle ¬∑ EV<br/>Find nearby charging stations for your electric car, scooter or bike</div>
      </div>

      <div class="vcard ice" onclick="selectVehicle('ice')">
        <div class="vcard-corner"></div>
        <div class="vcheck">‚úì</div>
        <span class="vbadge">FUEL VEHICLE</span>
        <span class="vicon">‚õΩüöó</span>
        <div class="vname">Petrol Gaadi</div>
        <div class="vhindi">‡§™‡•á‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§ó‡§æ‡§°‡§º‡•Ä</div>
        <div class="vdesc">Petrol / Diesel Vehicle<br/>Locate nearby petrol pumps and CNG stations quickly</div>
      </div>

    </div>
  </div>

  <div id="step-range">
    <div class="range-top">
      <div class="range-type-chip"><span id="range-icon">‚ö°</span><span id="range-label">Bijli Gaadi ‚Äî EV Charging</span></div>
      <h2>How far should we search?</h2>
      <p>Select your preferred radius from your current location</p>
    </div>

    <div class="rpills">
      <div class="rpill" onclick="selectRange(5,this)">5</div>
      <div class="rpill" onclick="selectRange(10,this)">10</div>
      <div class="rpill" onclick="selectRange(15,this)">15</div>
      <div class="rpill" onclick="selectRange(20,this)">20</div>
      <div class="rpill" onclick="selectRange(25,this)">25</div>
    </div>

    <div class="loc-card">
      <div class="loc-card-title">üìç YOUR LOCATION</div>

      <div class="segtabs">
        <button class="segtab active" id="tab-city" onclick="switchLocTab('city')">üèôÔ∏è City / Area</button>
        <button class="segtab" id="tab-pin" onclick="switchLocTab('pin')">üî¢ PIN Code</button>
      </div>

      <div id="panel-city">
        <!-- HTTPS warning banner ‚Äî shown only on http:// on real hosts -->
        <div class="https-warn" id="https-warn">
          ‚ö†Ô∏è <span>GPS requires <strong>HTTPS</strong>. This page is on HTTP. Please open it via <strong>https://</strong> for GPS to work, or type your city name below.</span>
        </div>
        <div class="city-row">
          <div class="citybox">
            <input type="text" id="loc-text-input" placeholder="Type city, area or address‚Ä¶ (e.g. Bandra, Mumbai)" autocomplete="off" oninput="onLocInput(this.value)" onkeydown="onLocKeydown(event)"/>
            <div class="clr-btn hidden" id="loc-clear" onclick="clearLocInput()">‚úï</div>
            <div class="suggest-list hidden" id="loc-suggestions"></div>
          </div>
          <button class="gps-btn" id="gps-btn" onclick="useGPS()" title="Use GPS">
            <span class="gps-ico" id="gps-icon">‚óé</span>
            <span class="gps-lbl" id="gps-label">GPS</span>
          </button>
        </div>
        <div class="hint" id="gps-hint">üí° Type a city / area name, or tap <strong>GPS</strong> to auto-detect</div>
      </div>

      <div id="panel-pin" class="hidden">
        <div class="pin-row">
          <div class="pinbox">
            <span class="pin-flag">üáÆüá≥</span>
            <input type="tel" id="loc-pin-input" placeholder="Enter 6-digit PIN  e.g. 400050" maxlength="6" autocomplete="postal-code" oninput="onPinInput(this.value)"/>
            <div class="clr-btn hidden" id="pin-clear" onclick="clearPinInput()">‚úï</div>
          </div>
          <button class="pin-go" id="pin-search-btn" onclick="searchByPin()" disabled>GO</button>
        </div>
        <div id="pin-status" class="pin-status hidden"></div>
        <div class="hint">üí° Enter any valid Indian 6-digit PIN code</div>
      </div>

      <div id="loc-confirmed" class="loc-confirmed hidden">
        <div class="loc-pulse"></div>
        <span id="loc-confirmed-text">Location set</span>
        <span id="loc-confirmed-coords" style="color:var(--t3);font-size:.72rem;margin-left:auto;font-weight:600;"></span>
      </div>
    </div>

    <button class="cta-btn" id="find-btn" onclick="findStations()" disabled style="opacity:.4;cursor:not-allowed;">
      üîç &nbsp;FIND STATIONS
    </button>
    <a href="#" class="back-link" onclick="goBack();return false;">‚Üê Change vehicle type</a>
  </div>

  <div id="step-results">
    <div class="results-nav">
      <h2 id="results-title">Nearby Stations</h2>
      <button class="restart-btn" onclick="goToStep1()">‚Üê Start Over</button>
    </div>

    <div id="loc-banner-results" class="info-bar hidden">
      <div class="loc-pulse"></div>
      <div><strong id="res-city">Your location</strong> <span>&nbsp;¬∑&nbsp; <span id="res-range-label"></span></span></div>
    </div>

    <div class="rangebar">
      <span class="rangebar-lbl">üî≠ RADIUS:</span>
      <div class="crpills">
        <div class="crpill" onclick="changeRange(5,this)">5 km</div>
        <div class="crpill" onclick="changeRange(10,this)">10 km</div>
        <div class="crpill" onclick="changeRange(15,this)">15 km</div>
        <div class="crpill" onclick="changeRange(20,this)">20 km</div>
        <div class="crpill" onclick="changeRange(25,this)">25 km</div>
      </div>
    </div>

    <div id="results-container"></div>
  </div>

</div>

<footer>
  Built for <span class="fe">‚ö° Bijli Gaadi</span> &amp; <span class="fi">‚õΩ Petrol Gaadi</span> owners across India &nbsp;¬∑&nbsp; GaadiStation v3.1
</footer>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CONFIG = {
  ACTIVE_API:       'osm',
  GOOGLE_API_KEY:   'YOUR_GOOGLE_API_KEY_HERE',
  MAX_RESULTS:      20,
  OSM_TIMEOUT_SEC:  12,
  CACHE_RESULTS:    true,
  OSM_OVERPASS_URLS: [
    'https://overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter',
    'https://maps.mail.ru/osm/tools/overpass/api/interpreter'
  ],
  OSM_NOMINATIM_URL: 'https://nominatim.openstreetmap.org',
};

/* ‚îÄ‚îÄ Nominatim w/ CORS fallback ‚îÄ‚îÄ */
const CORS_PROXIES = [
  u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
];
function nominatimFetch(path) {
  const fullUrl = CONFIG.OSM_NOMINATIM_URL + path;
  const headers = { 'Accept':'application/json' };
  const attempts = [() => fetch(fullUrl,{headers}), ...CORS_PROXIES.map(px => () => fetch(px(fullUrl),{headers}))];
  function tryNext(i) {
    if (i >= attempts.length) return Promise.reject(new Error('All Nominatim endpoints failed'));
    return attempts[i]().then(r => { if (!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .catch(e => { console.warn(`Nominatim attempt ${i+1} failed:`,e.message); return tryNext(i+1); });
  }
  return tryNext(0);
}

const hasGoogleKey = () => CONFIG.GOOGLE_API_KEY && CONFIG.GOOGLE_API_KEY !== 'YOUR_GOOGLE_API_KEY_HERE';

/* ‚îÄ‚îÄ Detect if we're on HTTP (non-localhost) ‚Äî GPS won't work there ‚îÄ‚îÄ */
const isHttpNonLocal = () =>
  location.protocol === 'http:' &&
  location.hostname !== 'localhost' &&
  location.hostname !== '127.0.0.1' &&
  !location.hostname.startsWith('192.168.');

let selectedVehicle = null, selectedRange = null, userLocation = null;
let locationName = 'Your Location', searchCache = {}, lastSearchKey = '';
let activeLocTab = 'city', suggestTimer = null;

/* ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ */
(function(){
  const c = document.getElementById('particles');
  for (let i=0;i<28;i++){
    const p = document.createElement('div');
    p.className = 'particle';
    const ev = Math.random()>.5, sz = Math.random()*4+1.5;
    p.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;background:${ev?'#16a34a':'#2563eb'};animation-duration:${9+Math.random()*13}s;animation-delay:${Math.random()*12}s;filter:blur(${Math.random()*1.2}px);`;
    c.appendChild(p);
  }
})();

/* ‚îÄ‚îÄ Show HTTPS warning banner if needed ‚îÄ‚îÄ */
(function(){
  if(isHttpNonLocal()){
    const w = document.getElementById('https-warn');
    if(w) w.classList.add('show');
    const btn = document.getElementById('gps-btn');
    if(btn){ btn.style.opacity='.45'; btn.title='GPS needs HTTPS'; }
    const hint = document.getElementById('gps-hint');
    if(hint) hint.innerHTML = '‚ö†Ô∏è GPS unavailable on HTTP. Type your city name, or open this page via <strong>https://</strong>';
  }
})();

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
let toastTimer = null;
function showToast(msg, dur=2800){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), dur);
}

/* ‚îÄ‚îÄ STEP 1: VEHICLE ‚îÄ‚îÄ */
function selectVehicle(type){
  selectedVehicle=type;
  document.querySelectorAll('.vcard').forEach(c=>c.classList.remove('selected'));
  document.querySelector('.vcard.'+type).classList.add('selected');
  document.body.classList.remove('mode-ev','mode-ice');
  document.body.classList.add('mode-'+type);
  setTimeout(()=>{
    document.getElementById('step-vehicle').style.display='none';
    document.getElementById('step-range').style.display='block';
    updateSteps(2);
    document.getElementById('range-icon').textContent  = type==='ev'?'‚ö°':'‚õΩ';
    document.getElementById('range-label').textContent = type==='ev'?'Bijli Gaadi ‚Äî EV Charging':'Petrol Gaadi ‚Äî Fuel Station';
    silentGPS();
  },280);
}

/* ‚îÄ‚îÄ LOCATION TAB ‚îÄ‚îÄ */
function switchLocTab(tab){
  activeLocTab=tab;
  document.getElementById('tab-city').classList.toggle('active',tab==='city');
  document.getElementById('tab-pin').classList.toggle('active', tab==='pin');
  document.getElementById('panel-city').classList.toggle('hidden',tab!=='city');
  document.getElementById('panel-pin').classList.toggle('hidden', tab!=='pin');
  if(userLocation){ userLocation=null; locationName='Your Location'; document.getElementById('loc-confirmed').classList.add('hidden'); checkFindBtn(); }
  if(tab==='city'){ document.getElementById('loc-text-input').value=''; document.getElementById('loc-clear').classList.add('hidden'); hideSuggestions(); setGpsState('idle'); }
  else { document.getElementById('loc-pin-input').value=''; document.getElementById('pin-clear').classList.add('hidden'); document.getElementById('pin-search-btn').disabled=true; hidePinStatus(); }
}
function switchLocTabSilent(tab){
  activeLocTab=tab;
  document.getElementById('tab-city').classList.toggle('active',tab==='city');
  document.getElementById('tab-pin').classList.toggle('active', tab==='pin');
  document.getElementById('panel-city').classList.toggle('hidden',tab!=='city');
  document.getElementById('panel-pin').classList.toggle('hidden', tab!=='pin');
}

/* ‚îÄ‚îÄ PIN ‚îÄ‚îÄ */
function onPinInput(val){
  const c=val.replace(/\D/g,'').slice(0,6);
  document.getElementById('loc-pin-input').value=c;
  document.getElementById('pin-clear').classList.toggle('hidden',c.length===0);
  document.getElementById('pin-search-btn').disabled=c.length!==6;
  hidePinStatus();
  if(c.length===6) searchByPin();
}
function clearPinInput(){
  document.getElementById('loc-pin-input').value='';
  document.getElementById('pin-clear').classList.add('hidden');
  document.getElementById('pin-search-btn').disabled=true;
  hidePinStatus(); userLocation=null; locationName='Your Location';
  document.getElementById('loc-confirmed').classList.add('hidden'); checkFindBtn();
}
function hidePinStatus(){ const e=document.getElementById('pin-status'); e.classList.add('hidden'); e.className='pin-status hidden'; }
function showPinStatus(msg,type){ const e=document.getElementById('pin-status'); e.classList.remove('hidden'); e.className=`pin-status ${type}`; e.textContent=msg; }
function searchByPin(){
  const pin=document.getElementById('loc-pin-input').value.replace(/\D/g,'');
  if(pin.length!==6){ showToast('Please enter a valid 6-digit PIN code'); return; }
  showPinStatus('üîç Looking up PIN code '+pin+'...','loading');
  nominatimFetch(`/search?postalcode=${pin}&country=India&format=json&addressdetails=1&limit=3`)
    .then(res=>{
      if(!res||!res.length){ showPinStatus(`‚ùå PIN ${pin} not found.`,'error'); return; }
      const r=res[0], a=r.address||{};
      const city=a.suburb||a.city_district||a.city||a.town||a.village||'Unknown Area';
      const state=a.state||'';
      const name=state?`${city}, ${state} ‚Äî ${pin}`:`${city} ‚Äî ${pin}`;
      userLocation={lat:parseFloat(r.lat),lng:parseFloat(r.lon)};
      locationName=name;
      showPinStatus(`‚úÖ ${name}`,'success');
      setLocConfirmed(name,r.lat,r.lon);
    })
    .catch(()=>showPinStatus('‚ö†Ô∏è Could not look up PIN. Check your connection.','error'));
}

/* ‚îÄ‚îÄ CITY SEARCH ‚îÄ‚îÄ */
function onLocInput(val){
  document.getElementById('loc-clear').classList.toggle('hidden',val.length===0);
  clearTimeout(suggestTimer);
  if(val.length<3){ hideSuggestions(); return; }
  suggestTimer=setTimeout(()=>fetchSuggestions(val),350);
}
function onLocKeydown(e){ if(e.key==='Escape') hideSuggestions(); }
function clearLocInput(){
  document.getElementById('loc-text-input').value='';
  document.getElementById('loc-clear').classList.add('hidden');
  hideSuggestions(); userLocation=null; locationName='Your Location';
  document.getElementById('loc-confirmed').classList.add('hidden'); checkFindBtn();
}
function resetAllLocFields(){
  document.getElementById('loc-text-input').value='';
  document.getElementById('loc-clear').classList.add('hidden');
  hideSuggestions(); setGpsState('idle');
  document.getElementById('loc-pin-input').value='';
  document.getElementById('pin-clear').classList.add('hidden');
  document.getElementById('pin-search-btn').disabled=true;
  hidePinStatus(); switchLocTabSilent('city');
  document.getElementById('loc-confirmed').classList.add('hidden');
}
function fetchSuggestions(q){
  const box=document.getElementById('loc-suggestions');
  box.classList.remove('hidden');
  box.innerHTML=`<div class="sug-load">üîç Searching...</div>`;
  nominatimFetch(`/search?q=${encodeURIComponent(q)}&countrycodes=in&format=json&addressdetails=1&limit=6`)
    .then(res=>{
      if(!res.length){ box.innerHTML=`<div class="sug-load">No results found</div>`; return; }
      box.innerHTML=res.map(r=>{
        const a=r.address||{};
        const main=a.city||a.town||a.village||a.county||r.display_name.split(',')[0];
        const sub=[a.state_district,a.state].filter(Boolean).join(', ');
        const ico=r.type==='city'||r.type==='administrative'?'üèôÔ∏è':r.type==='suburb'?'üèòÔ∏è':'üìç';
        return `<div class="sug-item" onclick="selectSuggestion('${r.lat}','${r.lon}','${escQ(main)}','${escQ(sub)}')">
          <span class="sug-ico">${ico}</span>
          <div><div class="sug-main">${main}</div>${sub?`<div class="sug-sub">${sub}</div>`:''}</div>
        </div>`;
      }).join('');
    })
    .catch(()=>{ box.innerHTML=`<div class="sug-load">‚ö†Ô∏è Search unavailable. Use GPS.</div>`; });
}
function escQ(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }
function selectSuggestion(lat,lon,main,sub){
  userLocation={lat:parseFloat(lat),lng:parseFloat(lon)};
  locationName=sub?`${main}, ${sub}`:main;
  document.getElementById('loc-text-input').value=locationName;
  document.getElementById('loc-clear').classList.remove('hidden');
  hideSuggestions(); setLocConfirmed(locationName,lat,lon); setGpsState('idle');
}
function hideSuggestions(){ document.getElementById('loc-suggestions').classList.add('hidden'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GPS ‚Äî FIXED for mobile browsers
   Root causes addressed:
   1. HTTP pages: browser blocks geolocation API entirely on mobile
   2. iOS Safari: needs Settings ‚Üí Privacy ‚Üí Location Services ‚Üí Safari ‚Üí Allow
   3. Chrome Android: needs lock icon ‚Üí Site Settings ‚Üí Location ‚Üí Allow
   4. maximumAge:0 forces fresh fix (avoids stale cached denials)
   5. Increased timeout to 15s for slow GPS locks indoors
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function silentGPS(){
  if(!navigator.geolocation) return;
  // Don't attempt on HTTP non-local ‚Äî will always fail on mobile
  if(isHttpNonLocal()) return;
  navigator.geolocation.getCurrentPosition(
    pos=>{
      if(userLocation) return; // already set by user typing
      userLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
      reverseGeocode(userLocation,true);
      setGpsState('active');
    },
    ()=>{},
    {timeout:6000,enableHighAccuracy:false,maximumAge:30000}
  );
}

function useGPS(){
  if(!navigator.geolocation){
    showToast('‚ùå GPS not supported on this browser');
    return;
  }

  // Hard block: mobile browsers will always deny on HTTP (not localhost)
  if(isHttpNonLocal()){
    showToast('‚ö†Ô∏è GPS requires HTTPS. Open this page via https:// or type your city name below.', 6000);
    setGpsState('idle');
    return;
  }

  setGpsState('loading');
  document.getElementById('loc-text-input').value='';
  document.getElementById('loc-clear').classList.add('hidden');
  hideSuggestions();

  navigator.geolocation.getCurrentPosition(
    pos=>{
      userLocation = {lat:pos.coords.latitude, lng:pos.coords.longitude};
      reverseGeocode(userLocation, true);
    },
    err=>{
      setGpsState('idle');
      const isIOS     = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isAndroid = /Android/i.test(navigator.userAgent);
      let msg;

      if(err.code === 1){ // PERMISSION_DENIED
        if(isIOS){
          msg = '‚õî Location denied. Fix: Settings ‚Üí Privacy & Security ‚Üí Location Services ‚Üí Safari (or your browser) ‚Üí "While Using App". Then reload.';
        } else if(isAndroid){
          msg = '‚õî Location denied. Fix: tap the üîí icon in the address bar ‚Üí Permissions ‚Üí Location ‚Üí Allow. Then retry GPS.';
        } else {
          msg = '‚õî Location denied. Click the üîí lock icon in the address bar, set Location to Allow, then try again.';
        }
      } else if(err.code === 2){ // POSITION_UNAVAILABLE
        msg = 'üì° Location unavailable. Make sure your phone\'s Location (GPS) is turned ON in system Settings, then retry.';
      } else if(err.code === 3){ // TIMEOUT
        msg = '‚è±Ô∏è GPS timed out. Try moving to an open area, or type your city name manually.';
      } else {
        msg = '‚ùå GPS error: ' + (err.message||'unknown') + '. Try typing your city name.';
      }

      showToast(msg, 8000);
    },
    {
      timeout:15000,
      enableHighAccuracy:true,
      maximumAge:0  // always request fresh position ‚Äî avoids stale permission state
    }
  );
}

function setGpsState(s){
  const btn=document.getElementById('gps-btn');
  const ico=document.getElementById('gps-icon');
  const lbl=document.getElementById('gps-label');
  btn.className='gps-btn';
  if(s==='loading'){ btn.classList.add('loading'); ico.textContent='‚ü≥'; lbl.textContent='Finding...'; }
  else if(s==='active'){ btn.classList.add('active'); ico.textContent='‚ú¶'; lbl.textContent='Located'; }
  else { ico.textContent='‚óé'; lbl.textContent='GPS'; }
  // Keep the button slightly dimmed on HTTP
  if(isHttpNonLocal()) btn.style.opacity='.45';
}

function reverseGeocode(loc,fromGps=false){
  nominatimFetch(`/reverse?lat=${loc.lat}&lon=${loc.lng}&format=json&zoom=14`)
    .then(data=>{
      const a=data.address;
      const city=a.suburb||a.neighbourhood||a.city||a.town||a.village||'Your Area';
      locationName=(a.state?`${city}, ${a.state}`:city);
      if(fromGps){
        document.getElementById('loc-text-input').value=locationName;
        document.getElementById('loc-clear').classList.remove('hidden');
        setGpsState('active');
      }
      setLocConfirmed(locationName,loc.lat.toFixed(4),loc.lng.toFixed(4));
    })
    .catch(()=>{
      locationName=`${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}`;
      if(fromGps){
        document.getElementById('loc-text-input').value=locationName;
        setGpsState('active');
      }
      setLocConfirmed(locationName,loc.lat.toFixed(4),loc.lng.toFixed(4));
    });
}

function setLocConfirmed(name,lat,lon){
  locationName=name;
  const el=document.getElementById('loc-confirmed');
  el.classList.remove('hidden');
  document.getElementById('loc-confirmed-text').textContent='‚úÖ '+name;
  document.getElementById('loc-confirmed-coords').textContent=`(${parseFloat(lat).toFixed(3)}, ${parseFloat(lon).toFixed(3)})`;
  checkFindBtn();
}
function checkFindBtn(){
  const btn=document.getElementById('find-btn'), ok=!!(userLocation&&selectedRange);
  btn.disabled=!ok; btn.style.opacity=ok?'1':'.4'; btn.style.cursor=ok?'pointer':'not-allowed';
}

document.addEventListener('click',e=>{ if(!e.target.closest('.citybox')) hideSuggestions(); });

/* ‚îÄ‚îÄ RANGE ‚îÄ‚îÄ */
function selectRange(km,el){
  selectedRange=km;
  document.querySelectorAll('.rpill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active'); checkFindBtn();
  if(userLocation) preWarmCache(km);
}
function preWarmCache(km){
  const lat=userLocation.lat, lng=userLocation.lng;
  const key=`${selectedVehicle}|${lat.toFixed(4)}|${lng.toFixed(4)}|${km}`;
  if(searchCache[key]) return;
  const amenity=selectedVehicle==='ev'?'charging_station':'fuel';
  const q=`[out:json][timeout:8];node["amenity"="${amenity}"](around:${km*1000},${lat},${lng});out ${CONFIG.MAX_RESULTS};`;
  fetch(CONFIG.OSM_OVERPASS_URLS[0],{method:'POST',body:q,headers:{'Content-Type':'text/plain'}})
    .then(r=>r.json()).then(data=>{
      if(searchCache[key]) return;
      searchCache[key]=(data.elements||[]).map(e=>({_source:'osm',name:e.tags?.name||e.tags?.operator||(selectedVehicle==='ev'?'EV Charging Station':'Petrol Pump'),lat:e.lat,lon:e.lon,addr:[e.tags?.['addr:street'],e.tags?.['addr:suburb'],e.tags?.['addr:city']].filter(Boolean).join(', '),rating:null,openNow:null,tags:e.tags||{}}));
    }).catch(()=>{});
}

/* ‚îÄ‚îÄ FIND ‚îÄ‚îÄ */
function findStations(){
  if(!selectedRange){ showToast('Please select a distance range first!'); return; }
  if(!userLocation) { showToast('üìç Please enter your location or use GPS first!',3000); return; }
  document.getElementById('step-range').style.display  ='none';
  document.getElementById('step-results').style.display='block';
  updateSteps(3);
  document.getElementById('results-title').textContent=selectedVehicle==='ev'?`‚ö° EV Charging within ${selectedRange} km`:`‚õΩ Petrol & CNG within ${selectedRange} km`;
  document.getElementById('loc-banner-results').classList.remove('hidden');
  document.getElementById('res-city').textContent=locationName;
  document.getElementById('res-range-label').textContent=`Within ${selectedRange} km`;
  showSkeletons(); syncCrPills(selectedRange); smartFetch();
}

/* ‚îÄ‚îÄ CHANGE RANGE ‚îÄ‚îÄ */
function changeRange(km,el){
  selectedRange=km;
  document.querySelectorAll('.crpill').forEach(p=>p.classList.remove('active','loading'));
  el.classList.add('active','loading');
  document.querySelectorAll('.rpill').forEach(p=>p.classList.remove('active'));
  const idx=[5,10,15,20,25].indexOf(km);
  const rp=document.querySelectorAll('.rpill');
  if(idx>=0&&rp[idx]) rp[idx].classList.add('active');
  document.getElementById('results-title').textContent=selectedVehicle==='ev'?`‚ö° EV Charging within ${km} km`:`‚õΩ Petrol & CNG within ${km} km`;
  document.getElementById('res-range-label').textContent=`Within ${km} km`;
  showSkeletons();
  smartFetch(()=>el.classList.remove('loading'));
}
function syncCrPills(km){ document.querySelectorAll('.crpill').forEach(p=>p.classList.toggle('active',parseInt(p.textContent)===km)); }

/* ‚îÄ‚îÄ SKELETON ‚îÄ‚îÄ */
function showSkeletons(){
  const card=d=>`<div class="rcard" style="animation-delay:${d}s;pointer-events:none;">
    <div style="display:flex;justify-content:space-between;margin-bottom:14px;">
      <div class="sk" style="height:15px;width:55%;"></div>
      <div class="sk" style="height:15px;width:18%;border-radius:10px;"></div>
    </div>
    <div class="sk" style="height:10px;width:80%;margin-bottom:8px;"></div>
    <div class="sk" style="height:10px;width:60%;margin-bottom:16px;"></div>
    <div style="display:flex;gap:7px;margin-bottom:12px;">
      <div class="sk" style="height:18px;width:55px;border-radius:6px;"></div>
      <div class="sk" style="height:18px;width:46px;border-radius:6px;"></div>
    </div>
    <div style="display:flex;gap:7px;">
      <div class="sk" style="height:34px;flex:1;border-radius:10px;"></div>
      <div class="sk" style="height:34px;flex:1;border-radius:10px;"></div>
    </div>
  </div>`;
  document.getElementById('results-container').innerHTML=`<div style="margin-bottom:16px;"><div class="sk" style="height:12px;width:140px;"></div></div><div class="rgrid">${[0,.06,.12,.18,.24,.3].map(d=>card(d)).join('')}</div>`;
}

/* ‚îÄ‚îÄ SMART FETCH ‚îÄ‚îÄ */
function smartFetch(onDone){
  const lat=userLocation.lat, lng=userLocation.lng;
  const key=`${selectedVehicle}|${lat.toFixed(4)}|${lng.toFixed(4)}|${selectedRange}`;
  if(CONFIG.CACHE_RESULTS&&searchCache[key]){ renderResults(searchCache[key],'cache'); if(onDone)onDone(); return; }
  lastSearchKey=key; showSkeletons();
  if((CONFIG.ACTIVE_API==='auto'||CONFIG.ACTIVE_API==='google')&&hasGoogleKey())
    fetchGooglePlaces(lat,lng,key,onDone);
  else fetchOverpassRace(key,onDone);
}

/* ‚îÄ‚îÄ GOOGLE PLACES ‚îÄ‚îÄ */
function fetchGooglePlaces(lat,lng,key,onDone){
  const r=selectedRange*1000, kw=selectedVehicle==='ev'?'EV charging station electric vehicle charger':'petrol pump fuel station CNG diesel', tp=selectedVehicle==='ev'?'electric_vehicle_charging_station':'gas_station';
  fetch(`https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lng}&radius=${r}&type=${tp}&keyword=${encodeURIComponent(kw)}&key=${CONFIG.GOOGLE_API_KEY}`)
    .then(r=>r.json()).then(data=>{
      if(data.status==='OK'&&data.results.length>0){
        const n=data.results.map(p=>({_source:'google',name:p.name,lat:p.geometry.location.lat,lon:p.geometry.location.lng,placeId:p.place_id,addr:p.vicinity||'',rating:p.rating||null,totalRatings:p.user_ratings_total||0,openNow:p.opening_hours?p.opening_hours.open_now:null,types:p.types||[]}));
        if(CONFIG.CACHE_RESULTS)searchCache[key]=n; renderResults(n,'google'); if(onDone)onDone();
      } else if(data.status==='REQUEST_DENIED'||data.status==='INVALID_REQUEST'){ showApiKeyErr(data.error_message||data.status); if(onDone)onDone(); }
      else fetchOverpassRace(key,onDone);
    }).catch(()=>fetchOverpassRace(key,onDone));
}

/* ‚îÄ‚îÄ OVERPASS RACE ‚îÄ‚îÄ */
function fetchOverpassRace(key,onDone){
  const lat=userLocation.lat, lng=userLocation.lng, r=selectedRange*1000;
  const amenity=selectedVehicle==='ev'?'charging_station':'fuel';
  const q=`[out:json][timeout:8];node["amenity"="${amenity}"](around:${r},${lat},${lng});out ${CONFIG.MAX_RESULTS};`;
  const ctrls=CONFIG.OSM_OVERPASS_URLS.map(()=>new AbortController());
  let done=false;
  function abortAll(){ ctrls.forEach(c=>{ try{c.abort()}catch(e){} }); }
  const fallback=setTimeout(()=>{
    if(done)return; done=true; abortAll();
    const m=generateMockData(); if(CONFIG.CACHE_RESULTS)searchCache[key]=m;
    renderResults(m,'mock'); if(onDone)onDone();
  },9000);
  CONFIG.OSM_OVERPASS_URLS.forEach((url,i)=>{
    setTimeout(()=>{
      if(done)return;
      fetch(url,{method:'POST',body:q,headers:{'Content-Type':'text/plain'},signal:ctrls[i].signal})
        .then(r=>r.json()).then(data=>{
          if(done)return; done=true; clearTimeout(fallback); abortAll();
          const n=(data.elements||[]).map(e=>({_source:'osm',name:e.tags?.name||e.tags?.operator||(selectedVehicle==='ev'?'EV Charging Station':'Petrol Pump'),lat:e.lat,lon:e.lon,addr:[e.tags?.['addr:street'],e.tags?.['addr:suburb'],e.tags?.['addr:city']].filter(Boolean).join(', '),rating:null,openNow:null,tags:e.tags||{}}));
          if(CONFIG.CACHE_RESULTS)searchCache[key]=n; renderResults(n,'osm'); if(onDone)onDone();
        }).catch(()=>{});
    },i*200);
  });
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function renderResults(stations,source){
  const c=document.getElementById('results-container');
  if(!stations||!stations.length){
    c.innerHTML=`<div class="empty-state"><div class="ico">${selectedVehicle==='ev'?'üîå':'‚õΩ'}</div><h3>No stations found nearby</h3><p>Try a wider search radius above.</p></div>`;
    return;
  }
  const sorted=stations.map(s=>({...s,_dist:calcDist(userLocation.lat,userLocation.lng,s.lat,s.lon)})).sort((a,b)=>a._dist-b._dist).slice(0,20);
  const srcTag={google:'<span style="color:#34a853;font-size:.7rem;font-weight:800;">‚óè Google</span>',osm:'<span style="color:#1e40af;font-size:.7rem;font-weight:800;">‚óè OSM</span>',mock:'<span style="color:#f59e0b;font-size:.7rem;font-weight:800;">‚óè Demo</span>',cache:'<span style="color:var(--t3);font-size:.7rem;font-weight:800;">‚óè Cached</span>'}[source]||'';
  const cards=sorted.map((s,i)=>{
    const lat=s.lat, lng=s.lon, dist=s._dist;
    const dl=dist<1?`${(dist*1000).toFixed(0)} m`:`${dist.toFixed(1)} km`;
    const mapsUrl=`https://www.google.com/maps/search/?api=1&query=${lat},${lng}${s.placeId?'&query_place_id='+s.placeId:''}`;
    const navUrl =`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    let sb='';
    if(s.openNow===true)  sb='<span class="rc-open">‚óè Open</span>';
    if(s.openNow===false) sb='<span class="rc-closed">‚óè Closed</span>';
    let rh='';
    if(s.rating){ const fs=Math.round(s.rating); rh=`<div class="rc-rating"><span class="stars">${'‚òÖ'.repeat(fs)+'‚òÜ'.repeat(5-fs)}</span> <strong>${s.rating}</strong>/5${s.totalRatings?` <span style="color:var(--t3);font-size:.7rem;">(${s.totalRatings.toLocaleString()})</span>`:''}</div>`; }
    let ft=[];
    if(s._source==='google'){ ft=selectedVehicle==='ev'?['EV Charging','Electric']:['Fuel Station','Petrol','Diesel']; }
    else {
      const t=s.tags||{};
      if(selectedVehicle==='ev'){ if(t['socket:type2'])ft.push('Type 2'); if(t['socket:chademo'])ft.push('CHAdeMO'); if(t['socket:ccs2'])ft.push('CCS2'); if(t['capacity'])ft.push(t['capacity']+' ports'); if(t['fee']==='no')ft.push('Free'); if(!ft.length)ft.push('EV Charging'); }
      else { if(t['fuel:diesel'])ft.push('Diesel'); if(t['fuel:petrol']||t['fuel:octane_91'])ft.push('Petrol'); if(t['fuel:cng'])ft.push('CNG'); if(t['fuel:lpg'])ft.push('LPG'); if(!ft.length)ft.push('Petrol','Diesel'); }
    }
    const mid='map-'+i;
    const b1=(parseFloat(lng)-.008).toFixed(6), b2=(parseFloat(lat)-.008).toFixed(6);
    const b3=(parseFloat(lng)+.008).toFixed(6), b4=(parseFloat(lat)+.008).toFixed(6);
    return `<div class="rcard" style="animation-delay:${i*.05}s">
      <div class="rc-head"><div class="rc-name">${s.name}</div><div class="rc-dist">${dl}</div></div>
      <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px;flex-wrap:wrap;">${sb}</div>
      <div class="rc-addr">üìç ${s.addr||'Address not available'}</div>
      <div class="rc-tags">${ft.map(f=>`<span class="rc-tag">${f}</span>`).join('')}</div>
      ${rh}
      <div class="rc-btns">
        <button class="rc-navigate" onclick="showInlineMap('${mid}',${lat},${lng},'${s.name.replace(/'/g,"\\'")}')">üó∫Ô∏è Show Map</button>
        <a class="rc-directions" href="${navUrl}" target="_blank">üß≠ Navigate</a>
      </div>
      <div class="inline-map hidden" id="${mid}">
        <div class="imap-bar">
          <span class="imap-title">üìç ${s.name}</span>
          <a class="imap-ext" href="${mapsUrl}" target="_blank">Google Maps ‚Üó</a>
          <button class="imap-close" onclick="hideInlineMap('${mid}')">‚úï</button>
        </div>
        <iframe src="https://www.openstreetmap.org/export/embed.html?bbox=${b1},${b2},${b3},${b4}&layer=mapnik&marker=${lat},${lng}" style="width:100%;height:240px;border:none;" loading="lazy" title="${s.name}"></iframe>
      </div>
    </div>`;
  }).join('');
  c.innerHTML=`<div style="display:flex;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:6px;"><span style="font-size:.8rem;color:var(--t2);">Found <strong style="color:var(--t1)">${sorted.length}</strong> stations${stations.length>20?` (nearest 20 of ${stations.length})`:''} </span>${srcTag}</div><div class="rgrid">${cards}</div>`;
}

/* ‚îÄ‚îÄ MOCK DATA ‚îÄ‚îÄ */
function generateMockData(){
  const en=['TATA Power EV Hub','Ather Grid','ChargeZone','Magenta ChargeGrid','Statiq Station','Jio-bp Electric'];
  const in_=['HP Petrol Pump','Indian Oil','Bharat Petroleum','Shell India','HPCL Fuel Station','Essar Petrol Pump'];
  const areas=['Bandra','Andheri','Powai','Dadar','Thane','Navi Mumbai','Borivali'];
  const names=selectedVehicle==='ev'?en:in_;
  const bLat=userLocation?userLocation.lat:18.9667, bLng=userLocation?userLocation.lng:72.8333;
  const sp=(selectedRange||10)/111;
  return Array.from({length:8},(_,i)=>({
    tags:{name:names[i%names.length],'addr:suburb':areas[i%areas.length],'addr:city':locationName.split(',')[0]||'Your City',...(selectedVehicle==='ev'?{'socket:type2':'yes',capacity:String(2+i%4)}:{'fuel:petrol':'yes','fuel:diesel':'yes'})},
    lat:bLat+(Math.random()-.5)*sp*1.5, lon:bLng+(Math.random()-.5)*sp*1.5,
    _source:'mock', rating:parseFloat((3.2+Math.random()*1.6).toFixed(1)),
    totalRatings:Math.floor(20+Math.random()*300), openNow:Math.random()>.3,
  }));
}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
function calcDist(la1,lo1,la2,lo2){ const R=6371,dLa=(la2-la1)*Math.PI/180,dLo=(lo2-lo1)*Math.PI/180,a=Math.sin(dLa/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLo/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
function showApiKeyErr(m){ document.getElementById('results-container').innerHTML=`<div class="empty-state"><div class="ico">üîë</div><h3>API Key Issue</h3><p>${m||'Check CONFIG.'}</p></div>`; }

function goBack(){
  document.getElementById('step-range').style.display  ='none';
  document.getElementById('step-vehicle').style.display='block';
  document.querySelectorAll('.vcard').forEach(c=>c.classList.remove('selected'));
  selectedVehicle=null; userLocation=null; locationName='Your Location';
  resetAllLocFields(); document.body.classList.remove('mode-ev','mode-ice'); updateSteps(1);
}
function goToStep1(){
  document.getElementById('step-results').style.display='none';
  document.getElementById('step-vehicle').style.display='block';
  document.querySelectorAll('.vcard').forEach(c=>c.classList.remove('selected'));
  document.querySelectorAll('.rpill').forEach(p=>p.classList.remove('active'));
  selectedVehicle=null; selectedRange=null; userLocation=null; locationName='Your Location';
  resetAllLocFields(); document.body.classList.remove('mode-ev','mode-ice');
  const btn=document.getElementById('find-btn'); btn.disabled=true; btn.style.opacity='.4'; btn.style.cursor='not-allowed';
  updateSteps(1); window.scrollTo({top:0,behavior:'smooth'});
}

function showInlineMap(id,lat,lng,name){
  const el=document.getElementById(id); if(!el)return;
  const was=el.classList.contains('hidden');
  document.querySelectorAll('.inline-map').forEach(m=>m.classList.add('hidden'));
  document.querySelectorAll('.rc-navigate').forEach(b=>{ if(b.textContent.includes('Hide'))b.textContent='üó∫Ô∏è Show Map'; });
  if(was){ el.classList.remove('hidden'); const c=el.closest('.rcard'); if(c){const b=c.querySelector('.rc-navigate');if(b)b.textContent='‚úï Hide Map';} setTimeout(()=>el.scrollIntoView({behavior:'smooth',block:'nearest'}),50); }
}
function hideInlineMap(id){
  const el=document.getElementById(id); if(!el)return; el.classList.add('hidden');
  const b=el.closest('.rcard')?.querySelector('.rc-navigate'); if(b)b.textContent='üó∫Ô∏è Show Map';
}

function updateSteps(active){
  for(let i=1;i<=3;i++){
    const el=document.getElementById('si-'+i);
    if(!el)continue;
    el.classList.remove('active','done');
    if(i===active)el.classList.add('active');
    else if(i<active)el.classList.add('done');
  }
  for(let i=1;i<=3;i++){
    const el=document.getElementById('msi-'+i);
    if(!el)continue;
    el.classList.remove('active','done');
    if(i===active)el.classList.add('active');
    else if(i<active)el.classList.add('done');
  }
}
</script>
</body>
</html>
